{% extends 'blog/layout.html' %}
{% load static %}

{% block body %}
<div class="form-container profile-edit-container">
    <h2>Edit Your Profile</h2>
    <form method="post" enctype="multipart/form-data" id="profile-edit-form">
        {% csrf_token %}

        {# Display non-field errors if any #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-group profile-picture-group">
            <label>Profile Picture</label>

            {% if profile_obj.profile_picture %}
                <div class="current-profile-picture-display">
                    <img src="{{ profile_obj.profile_picture.url }}" alt="Current Profile Picture" class="current-avatar">
                </div>
                <label>
                    <input type="checkbox" name="profile_picture-clear" id="profile_picture-clear_id">
                    Remove current picture
                </label><br>
            {% else %}
                <div class="no-current-profile-picture">
                    <img src="{% static 'blog/images/default-avatar.png' %}" alt="No profile picture" class="current-avatar default-avatar">
                    <p>No profile picture set.</p>
                </div>
            {% endif %}

            <div class="file-input-wrapper">
                <input type="file"
                       name="{{ form.profile_picture.html_name }}"
                       id="{{ form.profile_picture.id_for_label }}"
                       class="hidden-file-input"
                       data-original-name="{{ form.profile_picture.html_name }}"
                       accept="image/*">
                <button type="button" class="custom-file-upload-button"
                        onclick="document.getElementById('{{ form.profile_picture.id_for_label }}').click()">Choose New Picture</button>
                <span id="file-name-display" class="file-name-display">No file selected.</span>
            </div>

            {% if form.profile_picture.errors %}
                <div class="field-errors">
                    {% for error in form.profile_picture.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.bio.id_for_label }}">Bio</label>
            {{ form.bio }}
            {% if form.bio.errors %}
                <div class="field-errors">
                    {% for error in form.bio.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <button type="submit" class="submit-button">Save Changes</button>
        <a href="{% url 'accounts:own_profile' %}" class="cancel-button">Cancel</a>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('{{ form.profile_picture.id_for_label }}');
        const fileNameDisplay = document.getElementById('file-name-display');

        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = 'No file selected.';
            }
        });
    });
</script>
{% endblock %}
